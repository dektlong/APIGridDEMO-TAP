#@ load("@ytt:data", "data")
---
#@ if data.values.private_registry.ecr:
#@   ecr_iam_arn = "arn:aws:iam::{}:role".format(data.values.clouds.aws.accountID)
#@ end

profile: iterate
shared:
  ingress_domain: #@ "{}.{}".format(data.values.dns.devSubDomain, data.values.dns.domain)
  ingress_issuer: #@ data.values.tap.devStageIngressIssuer
  image_registry:
    #@ if data.values.private_registry.ecr:
    project_path: #@ "{}.dkr.ecr.{}.amazonaws.com/{}".format(data.values.clouds.aws.accountID, data.values.clouds.aws.region, data.values.private_registry.repo)
    #@ else:
    project_path: #@ "{}/{}".format(data.values.private_registry.host, data.values.private_registry.repo)
    username: #@ data.values.private_registry.username
    password: #@ data.values.private_registry.password
    #@ end
supply_chain: testing

ootb_supply_chain_testing:
  gitops:
    server_address: #@ data.values.gitops.server
    repository_owner: #@ data.values.gitops.owner
    repository_name: #@ data.values.gitops.repo
    commit_message: #@ "Generated by TAP on " + data.values.clusters.dev.name + " cluster" 

#@ if data.values.private_registry.ecr:
buildservice:
  kp_default_repository_aws_iam_role_arn: #@ ecr_iam_arn
cartographer:
  aws_iam_role_arn: #@ ecr_iam_arn
source_controller:
  aws_iam_role_arn: #@ ecr_iam_arn
#@ end

namespace_provisioner:
  controller: true
  #@ if data.values.private_registry.ecr:
  aws_iam_role_arn: #@ ecr_iam_arn
  #@ end
  additional_sources:
  - git:
      ref: origin/main
      subPath: #@ data.values.gitops.subPath
      url: #@ "{}/{}/{}.git".format(data.values.gitops.server, data.values.gitops.owner, data.values.gitops.repo)
    path: #@ "_ytt_lib/" + data.values.gitops.subPath
  overlay_secrets:
  - name: git-creds-sa-overlay
    namespace: tap-install
    create_export: true
cnrs:
  domain_template: '{{.Name}}.{{.Domain}}'
contour:
  envoy:
    service:
      type: LoadBalancer
appliveview_connector:
  activateSensitiveOperations: true
  backend:
    sslDeactivated: false
    host: #@ "{}.{}.{}".format("appliveview", data.values.dns.sysSubDomain, data.values.dns.domain)
    ingressEnabled: true
    caCertData: UPDATED_IN_RUNTIME

api_auto_registration:
  tap_gui_url: #@ "{}.{}.{}".format("https://tap-gui", data.values.dns.sysSubDomain, data.values.dns.domain)
excluded_packages:
  - learningcenter.tanzu.vmware.com
  - workshops.learningcenter.tanzu.vmware.com
  - tap-telemetry.tanzu.vmware.com
ceip_policy_disclosed: true
