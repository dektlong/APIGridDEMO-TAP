#@ load("@ytt:data", "data")
---
profile: build
shared:
  ingress_domain: #@ "{}.{}".format(data.values.dns.stageSubDomain, data.values.dns.domain)
  ingress_issuer: #@ data.values.tap.appsIngressIssuer
  image_registry:
    project_path: #@ "{}/{}".format(data.values.private_registry.host, data.values.private_registry.repo)
    username: #@ data.values.private_registry.username
    password: #@ data.values.private_registry.password
    
supply_chain: testing_scanning

ootb_supply_chain_testing_scanning:
  gitops:
    server_address: #@ data.values.gitops.server
    repository_owner: #@ data.values.gitops.owner
    repository_name: #@ data.values.gitops.deliverables.stageRepo
    commit_message: #@ "Generated by TAP on " + data.values.clusters.stage.name + " cluster" 

namespace_provisioner:
  controller: true
  additional_sources:
  - git:
      ref: origin/main
      subPath: #@ data.values.gitops.resources.subPath
      url: #@ "{}/{}/{}.git".format(data.values.gitops.server, data.values.gitops.owner, data.values.gitops.resources.repo)
    path: #@ "_ytt_lib/" + data.values.gitops.resources.subPath
  overlay_secrets:
  - name: git-creds-sa-overlay
    namespace: tap-install
    create_export: true


grype:
  namespace: "" 
  metadataStore:
    url: #@ "{}.{}.{}".format("https://metadata-store", data.values.dns.sysSubDomain, data.values.dns.domain)
    caSecret:
        name: store-ca-cert
        importFromNamespace: metadata-store-secrets
    authSecret:
        name: store-auth-token
        importFromNamespace: metadata-store-secrets
scanning:
  metadataStore: {} 

cnrs:
  domain_template: '{{.Name}}.{{.Domain}}'
contour:
  envoy:
    service:
      type: LoadBalancer
appliveview_connector:
  activateSensitiveOperations: true
  backend:
    sslDeactivated: false
    host: #@ "{}.{}.{}".format("appliveview", data.values.dns.sysSubDomain, data.values.dns.domain)
    ingressEnabled: true

api_auto_registration:
  tap_gui_url: #@ "{}.{}.{}".format("https://tap-gui", data.values.dns.sysSubDomain, data.values.dns.domain)
excluded_packages:
  - learningcenter.tanzu.vmware.com
  - workshops.learningcenter.tanzu.vmware.com
  - tap-telemetry.tanzu.vmware.com
ceip_policy_disclosed: true
