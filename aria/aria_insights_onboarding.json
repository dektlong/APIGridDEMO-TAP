{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "actionGroupName": {
      "type": "string",
      "defaultValue": "vmware-aria-insights-action-group",
      "metadata": {
        "description": "Unique name (within the Resource Group) for the Action group."
      }
    },
    "actionGroupShortName": {
      "type": "string",
      "defaultValue": "vmw-aria-ag",
      "metadata": {
        "description": "Short name (maximum 12 characters) for the Action group."
      }
    },
    "environmentSuffix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "A suffix to append to resources to make them unique for multiple environments"
      }
    },
    "processingRuleName": {
      "type": "string",
      "defaultValue": "vmware-aria-insights-processing-rule",
      "metadata": {
        "description": "Name for processing rule."
      }
    },
    "webhookReceiverName": {
      "type": "string",
      "defaultValue": "vmware-aria-insights-webhook",
      "metadata": {
        "description": "Webhook receiver service Name."
      }
    },
    "webhookServiceUri": {
      "type": "string",
      "metadata": {
        "description": "Webhook receiver service URI."
      }
    },
    "useCommonAlertSchema": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "whether to enable to common alert schema on the receiver"
      }
    }
  },
  "variables": {
    "actionGroupName": "[if(empty(parameters('environmentSuffix')), parameters('actionGroupName'), join(createArray(parameters('actionGroupName'), parameters('environmentSuffix')), '-'))]",
    "actionRuleName": "[if(empty(parameters('environmentSuffix')), parameters('processingRuleName'), join(createArray(parameters('processingRuleName'), parameters('environmentSuffix')), '-'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/actionGroups",
      "apiVersion": "2019-06-01",
      "name": "[variables('actionGroupName')]",
      "location": "Global",
      "properties": {
        "groupShortName": "[parameters('actionGroupShortName')]",
        "enabled": true,
        "smsReceivers": [
        ],
        "emailReceivers": [
        ],
        "webhookReceivers": [
          {
            "name": "[parameters('webhookReceiverName')]",
            "serviceUri": "[parameters('webhookServiceUri')]",
            "useCommonAlertSchema": "[parameters('useCommonAlertSchema')]"
          }
        ]
      }
    },
    {
      "type": "Microsoft.AlertsManagement/actionRules",
      "apiVersion": "2021-08-08",
      "name": "[variables('actionRuleName')]",
      "location": "Global",
      "tags": {
      },
      "properties": {
        "actions": [
          {
              "actionType": "AddActionGroups",
              "actionGroupIds": [
                   "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
              ]
          }
        ],
        "conditions": [
          {
              "field": "SignalType",
              "operator": "Equals",
              "values": [
                  "Metric"
              ]
          }
        ],
        "description": "(VMware Aria) Alert Processing Rule to capture all alerts in the target Subscription",
        "enabled": true,
        "scopes": [
            "[subscription().id]"
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "actionGroupResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/actionGroups',variables('actionGroupName'))]"
    },
    "actionRuleResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.AlertsManagement/actionRules', variables('actionRuleName') )]"
    }
  }
}